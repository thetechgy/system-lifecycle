---
# Bashrc alias configuration tasks
# Replicates functionality from configure-bashrc.sh

- name: Set repository root fact
  ansible.builtin.set_fact:
    repo_root: "{{ playbook_dir | dirname | dirname | dirname }}"

- name: Check if .bashrc exists
  ansible.builtin.stat:
    path: "{{ bashrc_home }}/.bashrc"
  register: bashrc_stat

- name: Add system-lifecycle aliases to .bashrc
  ansible.builtin.blockinfile:
    path: "{{ bashrc_home }}/.bashrc"
    marker: "# {mark}"
    marker_begin: ">>> system-lifecycle >>>"
    marker_end: "<<< system-lifecycle <<<"
    block: |
      # Aliases managed by system-lifecycle - do not edit manually
      alias update-system='cd {{ repo_root }}/linux/ansible && ansible-playbook -K -i inventory/localhost.yml playbooks/update-system.yml'
    state: "{{ bashrc_state }}"
    create: "{{ bashrc_state == 'present' }}"
    backup: true
  register: bashrc_update
  when: bashrc_state == 'present' or bashrc_stat.stat.exists

- name: Display configuration result (added/updated)
  ansible.builtin.debug:
    msg: "Aliases configured in {{ bashrc_home }}/.bashrc. Run 'source ~/.bashrc' to activate."
  when:
    - bashrc_update is defined
    - bashrc_state == 'present'
    - bashrc_update is changed

- name: Display configuration result (removed)
  ansible.builtin.debug:
    msg: "Managed section removed from {{ bashrc_home }}/.bashrc"
  when:
    - bashrc_update is defined
    - bashrc_state == 'absent'
    - bashrc_update is changed

- name: Display no changes message
  ansible.builtin.debug:
    msg: "No changes needed to {{ bashrc_home }}/.bashrc"
  when:
    - bashrc_update is defined
    - bashrc_update is not changed
