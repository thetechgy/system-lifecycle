---
# Firmware update tasks via fwupdmgr
# Note: is_wsl fact must be set before this runs

- name: Skip firmware updates on WSL
  ansible.builtin.debug:
    msg: "WSL detected - firmware updates not supported in virtualized environment"
  when: is_wsl | default(false)

- name: Firmware update tasks (non-WSL only)
  when: not (is_wsl | default(false))
  block:
    - name: Check if fwupdmgr is installed
      ansible.builtin.command: fwupdmgr --version
      register: fwupdmgr_check
      changed_when: false
      failed_when: false

    - name: Install fwupd if not present
      ansible.builtin.apt:
        name: fwupd
        state: present
      environment:
        DEBIAN_FRONTEND: noninteractive
      when: fwupdmgr_check.rc != 0

    - name: Refresh firmware metadata
      ansible.builtin.command: fwupdmgr refresh --force
      register: fwupd_refresh
      changed_when: false
      failed_when: false

    - name: Check for available firmware updates
      ansible.builtin.command: fwupdmgr get-updates
      register: fwupd_available
      changed_when: false
      failed_when: false

    - name: Display available firmware updates
      ansible.builtin.debug:
        msg: "{{ (fwupd_available.stdout_lines | default([])) + (fwupd_available.stderr_lines | default([])) }}"

    - name: Apply firmware updates
      ansible.builtin.command: fwupdmgr update -y
      register: fwupd_update
      changed_when: "'Successfully installed' in fwupd_update.stdout"
      failed_when: false

    - name: Display firmware update results
      ansible.builtin.debug:
        msg: "{{ (fwupd_update.stdout_lines | default([])) + (fwupd_update.stderr_lines | default([])) }}"

    - name: Warn if firmware update reported errors
      ansible.builtin.debug:
        msg: "Warning: firmware update reported errors"
      when: fwupd_update.rc != 0
